# ДЗ по теме Проекции и материализованные представления

## Описание/Пошаговая инструкция выполнения домашнего задания:

1. Создание таблицы:

```sql
/*
Создайте таблицу sales с полями:
id (UInt32) — уникальный идентификатор продажи
product_id (UInt32) — идентификатор продукта
quantity (UInt32) — количество проданных единиц
price (Float32) — цена за единицу
sale_date (DateTime) — дата продажи
Заполните таблицу тестовыми данными.
*/
create table sales 
(
    id         UInt32   comment 'уникальный идентификатор продажи',
    product_id UInt32   comment 'идентификатор продукта',
    quantity   UInt32   comment 'количество проданных единиц',
    price      Float32  comment 'цена за единицу',
    sale_date  DateTime comment 'дата продажи',
)
engine=MergeTree
order by id;

insert into sales
select
    number as id
    , floor(randUniform(1, 11)) as product_id
    , floor(randUniform(1, 5)) as quantity
    , round(randUniform(5.5, 10), 2) as price
    , toDate('2024-01-01') + interval (floor(id/100)) days as sale_date 
from numbers(1, 1000);
```

2. Создание проекции: Создайте проекцию для таблицы sales, которая будет агрегировать данные по product_id и считать общую сумму продаж (количество и сумма по цене) за каждый продукт.
```sql
ALTER TABLE sales DROP PROJECTION IF EXISTS sales_product_agg_proj;
ALTER TABLE sales
    ADD PROJECTION sales_product_agg_proj
    (
        SELECT product_id, sum(quantity * price)
        GROUP BY product_id
    )
;
ALTER TABLE sales MATERIALIZE PROJECTION sales_product_agg_proj;
```

3. Создание материализованного представления: Создайте материализованное представление sales_mv, которое будет автоматически обновляться при вставке новых данных в таблицу sales. Оно должно хранить общие продажи по продуктам с полями:
- product_id
- total_quantity
- total_sales
```sql
create table sales_product_agg_tbl
(
    product_id UInt32,
    total_quantity UInt32,
    total_sales Float32
)
engine=SummingMergeTree()
order by product_id
;

drop table if exists sales_mv;
CREATE MATERIALIZED VIEW sales_mv TO sales_product_agg_tbl
as
select
    product_id
    , quantity as total_quantity
    , quantity * price as total_sales
from sales
;

insert into sales_product_agg_tbl
select
    product_id
    , quantity as total_quantity
    , quantity * price as total_sales
from sales
;

```

4. Запросы к данным: 
- Напишите запрос, который извлекает данные из проекции sales_projection.
- Напишите запрос, который извлекает данные из материализованного представления sales_mv.
```sql
select *
from sales_product_agg_tbl;  -- так как была одна вставка - можно без final,  в дальнейшем с final
/*
    ┌─product_id─┬─total_quantity─┬─total_sales─┐
 1. │          1 │            259 │   2040.9297 │
 2. │          2 │            236 │   1822.2399 │
 3. │          3 │            219 │   1700.1304 │
 4. │          4 │            219 │   1693.6001 │
 5. │          5 │            242 │   1855.2703 │
 6. │          6 │            199 │   1548.2202 │
 7. │          7 │            307 │      2362.3 │
 8. │          8 │            250 │   1876.9597 │
 9. │          9 │            273 │   2095.5798 │
10. │         10 │            311 │   2411.3804 │
    └────────────┴────────────────┴─────────────┘
↓ Progress: 10.00 rows, 120.00 B (1.22 thousand rows/s., 14.68 KB/s.)  99
↙ Progress: 10.00 rows, 120.00 B (1.22 thousand rows/s., 14.68 KB/s.)  99
[b9b88b2bfd46] 2024.12.14 19:54:56.088461 [ 68 ] {9fa3f72f-3d6b-4d8e-ad87-04915200cb6b} <Debug> executeQuery: Read 10 rows, 120.00 B in 0.007884 sec., 1268.3916793505834 rows/sec., 14.86 KiB/sec.
[b9b88b2bfd46] 2024.12.14 19:54:56.088658 [ 68 ] {9fa3f72f-3d6b-4d8e-ad87-04915200cb6b} <Debug> TCPHandler: Processed in 0.0088115 sec.

10 rows in set. Elapsed: 0.008 sec.
*/

set optimize_use_projections=1;
SELECT product_id, sum(quantity * price)
from sales
GROUP BY product_id
order by product_id
/*
...
-9b88e37f3766} <Trace> default.sales (633012b4-5da6-4199-a1a5-172e1cae3946) (SelectExecutor): Reading 1 ranges in order from part sales_product_agg_proj, approx. 10 rows starting from 0
...
    ┌─product_id─┬─sum(multiply(quantity, price))─┐
 1. │          1 │             2040.9300026893616 │
 2. │          2 │              1822.239993095398 │
 3. │          3 │             1700.1299991607666 │
 4. │          4 │             1693.6000046730042 │
 5. │          5 │              1855.269998550415 │
 6. │          6 │             1548.2199931144714 │
 7. │          7 │              2362.299997806549 │
 8. │          8 │             1876.9600019454956 │
 9. │          9 │             2095.5799975395203 │
10. │         10 │             2411.3800010681152 │
    └────────────┴────────────────────────────────┘
[b9b88b2bfd46] 2024.12.14 19:57:54.313522 [ 68 ] {6f30d300-1213-4b19-9f7a-9b88e37f3766} <Debug> executeQuery: Read 10 rows, 200.00 B in 0.094599 sec., 105.7093626782524 rows/sec., 2.06 KiB/sec.
[b9b88b2bfd46] 2024.12.14 19:57:54.313976 [ 68 ] {6f30d300-1213-4b19-9f7a-9b88e37f3766} <Debug> MemoryTracker: Peak memory usage (for query): 177.79 KiB.
[b9b88b2bfd46] 2024.12.14 19:57:54.313998 [ 68 ] {6f30d300-1213-4b19-9f7a-9b88e37f3766} <Debug> TCPHandler: Processed in 0.097172542 sec.

10 rows in set. Elapsed: 0.097 sec. 
*/
```

5. Сравнение производительности: Сравните время выполнения запроса к основной таблице sales с запросом к проекции sales_projection и материализованному представлению sales_mv. Обратите внимание на разницу в производительности.
```sql
-- вставим побольше данных и повторим запрос
insert into sales
select
    number as id
    , floor(randUniform(1, 11)) as product_id
    , floor(randUniform(1, 5)) as quantity
    , round(randUniform(5.5, 10), 2) as price
    , toDate('2024-01-01') + interval (floor(id/100)) days as sale_date 
from numbers(1, 1000000);

-- MV
select *
from sales_product_agg_tbl final;
/*
    ┌─product_id─┬─total_quantity─┬─total_sales─┐
 1. │          1 │         251257 │   1947876.8 │
 2. │          2 │         250875 │   1943786.1 │
 3. │          3 │         250714 │   1942574.8 │
 4. │          4 │         249759 │   1935997.2 │
 5. │          5 │         250125 │     1937058 │
 6. │          6 │         251103 │     1946015 │
 7. │          7 │         249579 │   1934450.2 │
 8. │          8 │         251025 │   1946221.2 │
 9. │          9 │         250859 │   1945889.5 │
10. │         10 │         250452 │   1942964.9 │
    └────────────┴────────────────┴─────────────┘
↓ Progress: 20.00 rows, 240.00 B (2.90 thousand rows/s., 34.84 KB/s.)  99↙ Progress: 20.00 rows, 240.00 B (2.90 thousand rows/s., 34.84 KB/s.)  99
[b9b88b2bfd46] 2024.12.14 20:00:07.344102 [ 68 ] {2ab22cf6-aad0-4c78-9fb6-bf0986fe14b9} <Debug> executeQuery: Read 20 rows, 240.00 B in 0.007457 sec., 2682.043717312592 rows/sec., 31.43 KiB/sec.
[b9b88b2bfd46] 2024.12.14 20:00:07.344334 [ 68 ] {2ab22cf6-aad0-4c78-9fb6-bf0986fe14b9} <Debug> TCPHandler: Processed in 0.0081665 sec.

10 rows in set. Elapsed: 0.008 sec. 
*/

-- Projection
optimize table sales;
SELECT product_id, sum(quantity * price)
from sales
GROUP BY product_id
order by product_id
settings optimize_use_projections=1;
/*
[b9b88b2bfd46] 2024.12.14 20:03:21.679735 [ 68 ] {e8e36eb1-1457-4708-8bc6-8988c5fac4ec} <Trace> default.sales (633012b4-5da6-4199-a1a5-172e1cae3946) (SelectExecutor): Reading 1 ranges in order from part sales_product_agg_proj, approx. 10 rows starting from 0
    ┌─product_id─┬─sum(multiply(quantity, price))─┐
 1. │          1 │              1947873.289703846 │
 2. │          2 │             1943802.2901320457 │
 3. │          3 │             1942573.9899425507 │
 4. │          4 │             1935998.9401044846 │
 5. │          5 │             1937066.9701304436 │
 6. │          6 │              1946024.079823494 │
 7. │          7 │             1934441.7397494316 │
 8. │          8 │             1946216.1999001503 │
 9. │          9 │              1945880.249970913 │
10. │         10 │             1942969.7800884247 │
    └────────────┴────────────────────────────────┘
↑ Progress: 10.00 rows, 200.00 B (1.02 thousand rows/s., 20.39 KB/s.)  99↗ Progress: 10.00 rows, 200.00 B (1.02 thousand rows/s., 20.39 KB/s.)  99
[b9b88b2bfd46] 2024.12.14 20:03:21.685319 [ 68 ] {e8e36eb1-1457-4708-8bc6-8988c5fac4ec} <Debug> executeQuery: Read 10 rows, 200.00 B in 0.010304 sec., 970.4968944099378 rows/sec., 18.96 KiB/sec.
[b9b88b2bfd46] 2024.12.14 20:03:21.685504 [ 68 ] {e8e36eb1-1457-4708-8bc6-8988c5fac4ec} <Debug> MemoryTracker: Peak memory usage (for query): 178.82 KiB.
[b9b88b2bfd46] 2024.12.14 20:03:21.685517 [ 68 ] {e8e36eb1-1457-4708-8bc6-8988c5fac4ec} <Debug> TCPHandler: Processed in 0.010899541 sec.

10 rows in set. Elapsed: 0.011 sec. 
*/
```

Вывод - мв выгоднее проекции.