# Storage policy и резервное копирование

Почему мы делаем бэкапы
- катастрофические сбои, в результате которых удаляются все данные
- случайное удаление бд или таблицы
- отладка проблем с использованием производственных данных
- тестирование обновлений перед изменением схемы или версии
- загрузка схемы и конфигурации для новых установок

Что нужно спасать?

![Что нужно спасать?](images/19_01.png)

Варианты бэкапирования

![Варианты бэкапирования](images/19_02.png)

## утилита clickhouse-backup

Работает на го и на питоне, есть репа. Можно поднять в докере.

инструмент для простого резервного копирования и восстановления ClickHouse с поддержкой многих типов облачных и необлачных хранилищ
- простое создание и восстановление резервных копий всех или определенных таблиц
- эффективное хранение нескольких резервных копий в файловой системе
- загрузка и выгрузка с потоковым сжатием
- работает с aws, gcs, azure, tencent cos, ftp, sftp
- поддержка atomic database engine
- поддержка многодисковых инсталляций (размещение бэкапов на нескольких дисках)
- поддержка пользовательских типов удаленных хранилищ
- поддержка инкрементного резервного копирования на удаленное хранилище

Установка
```bash

```

Подготовка конфигов
```bash

```
Это не дефолтный конфиг - это шаблон

Создание бэкапа

![Создание бэкапа](images/19_03.png)

Точно так же мы можем сделать руками:

![Создание бэкапа](images/19_04.png)

Восстановление из бэкапа

Точно так же мы можем сделать руками:

![Восстановление из бэкапа](images/19_06.png)

По сути, все бэкапы - это перебор хардлинками

Примеры команд для бэкапа и восстановления из бэкапа + полезные команды
```bash

```

встроенные backup/restore

```bash

```

## Storage policy

- правила хранения и управления данными (Storage policy определяет, как и где зранятся данные)
- контроллирает, где и как хрянятся данные (определяет мет)
- оптимизирует производительность и использование ресурсов

![что такое сторадж полиси](images/19_07.png)

```bash
/url_schema_mappers
/storage_configuration
```

Различные типы дисков
- локальные диски - высокая с
- сетевые
- облачные хранилища (s3, hdfs) - масштабируемое, экономичное

создание Storage policy

плюсы использования Storage policy
- эффективный поиск данных и выполнение запросов
- оптимизация затрат на хранение данных за счет использования соответствующих типов дисков
- масштабируемость

Полезные запросы для проверки наших дисков
```bash
du -lh /var/lib/clickhouse
```

А можем рассмотреть пример с настройкой ттл на выгрузку на с3 вместо удаления?

еще к вопросам (можем на q&a, если долго настраивать) - А можем рассмотреть пример с настройкой ттл на выгрузку на с3 вместо удаления? ну и пример селекта этих данных с с3

https://clickhouse.com/docs/en/operations/backup